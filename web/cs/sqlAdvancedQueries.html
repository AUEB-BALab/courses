<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Advanced queries</title>

    <!-- Bootstrap -->
    <!-- JQuery is required -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="../css/pandoc-syntax.css">
  </head>
  <body>
<h1 id="coding-bootcamp-advanced-queries">Coding Bootcamp: Advanced queries</h1>
<h2 id="sql-having-clause">SQL HAVING clause</h2>
<p>A HAVING clause specifies that an SQL SELECT statement should only return rows where aggregate values meet the specified conditions.<br />
It was added to the SQL language because the WHERE keyword could not be used with aggregate functions<br />
Remember, WHERE for conditions before grouping, HAVING for conditions after grouping.</p>
<p>Syntax:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> column_name, aggregate_function(column_name)
<span class="kw">FROM</span> table_name
<span class="kw">WHERE</span> column_name <span class="kw">operator</span> <span class="fu">value</span>
<span class="kw">GROUP</span> <span class="kw">BY</span> column_name
<span class="kw">HAVING</span> aggregate_function(column_name) <span class="kw">operator</span> <span class="fu">value</span>;</code></pre></div>
<h2 id="sql-having-clause-example">SQL HAVING clause example</h2>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">-- Which customers have never made an order;</span>
<span class="kw">SELECT</span>  C.CustomerID,
        C.CompanyName,
        <span class="fu">COUNT</span>(O.OrderID) [Total <span class="fu">Count</span> <span class="kw">of</span> Orders]
<span class="kw">FROM</span> Customers C
    <span class="kw">LEFT</span> <span class="kw">JOIN</span> Orders O <span class="kw">ON</span> C.CustomerID = O.CustomerID
<span class="kw">GROUP</span> <span class="kw">BY</span> C.CustomerID, C.CompanyName
<span class="kw">HAVING</span> <span class="fu">COUNT</span>(O.OrderID) = <span class="dv">0</span>;</code></pre></div>
<h2 id="sql-like-operator-wildcards">SQL LIKE Operator &amp; Wildcards</h2>
<p>The LIKE operator is used to search for a specified pattern in a column.<br />
Wildcard characters are used with the SQL LIKE operator.<br />
We will need the following:</p>
<ol>
<li>% A substitute for zero or more characters</li>
<li>_ A substitute for a single character</li>
</ol>
<h2 id="examples">Examples</h2>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">-- Returns Customers from Bern, Berlin and Bergamo</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> Customers
<span class="kw">WHERE</span> City <span class="kw">LIKE</span> <span class="st">&#39;ber%&#39;</span>;
<span class="co">-- Returns Customers from Bruxelles, Resende, Buenos Aires etc.</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> Customers
<span class="kw">WHERE</span> City <span class="kw">LIKE</span> <span class="st">&#39;%es%&#39;</span>;  
<span class="co">-- Returns Customers with regions CA and WA</span>
<span class="kw">select</span> *
<span class="kw">from</span> Customers
<span class="kw">where</span> Region <span class="kw">like</span> <span class="st">&#39;_A&#39;</span></code></pre></div>
<h2 id="sql-round-function">SQL ROUND function</h2>
<p>The ROUND() function is used to round a numeric field to the number of decimals specified.</p>
<p>Syntax</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> <span class="fu">ROUND</span>(column_name,decimals) <span class="kw">FROM</span> table_name;</code></pre></div>
<p>Example</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">-- Find the total price for order with orderid = 10266 and productID = 12</span>
<span class="kw">SELECT</span> <span class="fu">ROUND</span>((UnitPrice * Quantity * (<span class="dv">1</span> - Discount)), <span class="dv">2</span>), *
<span class="kw">FROM</span> [<span class="kw">Order</span> Details]
<span class="kw">WHERE</span> OrderID = <span class="dv">10266</span>;</code></pre></div>
<h2 id="sql-select-top-clause">SQL SELECT TOP Clause</h2>
<p>The SELECT TOP clause is used to specify the number of records to return.</p>
<p>Syntax</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> TOP number|percent column_name(s)
<span class="kw">FROM</span> table_name;</code></pre></div>
<h3 id="sql-select-top-equivalent-in-mysql">SQL SELECT TOP Equivalent in MySQL</h3>
<p>MySQL Syntax</p>
<pre class="mysql"><code>SELECT column_name(s)
FROM table_name
LIMIT number;</code></pre>
<h2 id="sql-isnull-function">SQL ISNULL Function</h2>
<p>Replaces NULL with the specified replacement value.</p>
<p>Syntax</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql">ISNULL ( check_expression , replacement_value )  </code></pre></div>
<h2 id="sql-isnull-examples">SQL ISNULL Examples</h2>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> ISNULL(<span class="kw">NULL</span>, <span class="st">&#39;TechOnTheNet.com&#39;</span>);
<span class="co">--Result: &#39;TechOnTheNet.com&#39;</span>
<span class="kw">SELECT</span> ISNULL(<span class="st">&#39;CheckYourMath.com&#39;</span>, <span class="st">&#39;TechOnTheNet.com&#39;</span>);
<span class="co">--Result: &#39;CheckYourMath.com&#39;</span>

<span class="kw">SELECT</span> ISNULL(<span class="kw">NULL</span>, <span class="dv">45</span>);
<span class="co">--Result: 45</span>
<span class="kw">SELECT</span> ISNULL(<span class="dv">12</span>, <span class="dv">45</span>);
<span class="co">--Result: 12</span>

<span class="kw">SELECT</span> ISNULL(<span class="kw">NULL</span>, <span class="st">&#39;2014-05-01&#39;</span>);
<span class="co">--Result: &#39;2014-05-01&#39;</span>
<span class="kw">SELECT</span> ISNULL(<span class="st">&#39;2014-04-30&#39;</span>, <span class="st">&#39;2014-05-01&#39;</span>);
<span class="co">--Result: &#39;2014-04-30&#39;</span></code></pre></div>
<h2 id="sql-variables">SQL Variables</h2>
<p>Object that holds a single data value of a specified type</p>
<p>Uses:</p>
<ul>
<li>Holds data for later use</li>
<li>Counters</li>
<li>As inputs or outputs to stored procedures, functions</li>
</ul>
<p>Syntax:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">DECLARE</span> &lt;@var_nam&gt; &lt;data_type&gt;</code></pre></div>
<h2 id="sql-variables-examples">SQL Variables examples</h2>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">DECLARE</span> @i <span class="dt">int</span>;
<span class="kw">DECLARE</span> @stringVar <span class="dt">VARCHAR</span>(<span class="dv">200</span>);
<span class="kw">DECLARE</span> @myDate DATETIME;</code></pre></div>
<h2 id="sql-variables-assigning-values">SQL Variables Assigning Values</h2>
<h3 id="set">SET</h3>
<p>Used to set a value to a scalar (not table) variable.<br />
Syntax:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">DECLARE</span> &lt;@var_nam&gt; &lt;data_type&gt;;
<span class="kw">SET</span> &lt;@var_nam&gt; = <span class="fu">value</span>;</code></pre></div>
<p>Example:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">DECLARE</span> @i <span class="dt">INT</span>;
<span class="kw">SET</span> @i = <span class="dv">10</span>;
<span class="kw">SET</span> @stringVar = <span class="st">&#39;Coding Bootcamp&#39;</span>;</code></pre></div>
<h2 id="sql-variables-assigning-values-1">SQL Variables Assigning Values</h2>
<h3 id="select">SELECT</h3>
<ul>
<li>Used to set a value to a scalar variable</li>
<li>Can be also used for setting values to multiple variables at once</li>
</ul>
<p>Syntax:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> @i = <span class="dv">1</span>,
       @stringVar = <span class="st">&#39;Coding Bootcamp&#39;</span>;
       @myDate = <span class="st">&#39;2016-10-24&#39;</span></code></pre></div>
<h2 id="set-vs-select-for-setting-values-to-variables">SET vs SELECT for setting values to variables</h2>
<ul>
<li>SET is the ANSI standard for variable assignment, SELECT is not</li>
<li>SET can only assign one variable at a time, SELECT can make multiple assignments at once</li>
<li>If assigning from a query, SET can only assign a scalar value. If the query returns multiple values/rows then SET will raise an error. SELECT will assign one of the values to the variable and hide the fact that multiple values were returned</li>
<li>When assigning from a query if there is no value returned then SET will assign NULL, where SELECT will not make the assignment at all (so the variable will not be changed from its previous value)</li>
<li>As far as speed differences - there are no direct differences between SET and SELECT. However SELECT's ability to make multiple assignments in one shot does give it a slight speed advantage over SET.</li>
</ul>
<h2 id="temporary-tables">Temporary tables</h2>
<p>Can be used as a workspace for intermediate results.</p>
<p>They can be</p>
<ul>
<li>Local temporary tables (starting with #)</li>
<li>Global temporary tables (starting with ##)</li>
<li>Table variables (starting with @)</li>
<li>Other (not in our lesson's scope)</li>
</ul>
<h2 id="table-variables">TABLE Variables</h2>
<ul>
<li>Used in the scope of the routine or batch within they are defined</li>
<li>Cause less recompiles</li>
<li>Not affected by rollbacks</li>
</ul>
<p>Syntax example:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">DECLARE</span> @myStudents <span class="kw">TABLE</span>
        (<span class="kw">ID</span> <span class="dt">int</span>,
        LastName <span class="dt">VARCHAR</span>(<span class="dv">50</span>),
        FirstName <span class="dt">VARCHAR</span>(<span class="dv">50</span>)
        );</code></pre></div>
<h2 id="temporary-tables-1">Temporary tables</h2>
<ul>
<li>Support every single feature a database table can feature</li>
<li>Can be altered after creation</li>
<li>Can have multiple indexes</li>
<li>Can be used with Dynamic SQL</li>
<li>Can be local (#) or global (##)</li>
</ul>
<p>Syntax example:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">CREATE</span> <span class="kw">TABLE</span> #myStudents
        (<span class="kw">ID</span> <span class="dt">int</span>,
        LastName <span class="dt">VARCHAR</span>(<span class="dv">50</span>),
        FirstName <span class="dt">VARCHAR</span>(<span class="dv">50</span>)
        );</code></pre></div>
<p>Remember, we may have to drop it manually!</p>
<h3 id="select-into">SELECT INTO</h3>
<p>We can take the results of a query and insert them into a NEW temporary table.<br />
The result set must have uniquely named columns that will be the new temporary table's columns.</p>
<p>Syntax:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">-- Create a temporary table that contains the id of each order and the total revenues of that order</span>
<span class="kw">SELECT</span> O.OrderID, <span class="fu">SUM</span>(<span class="fu">ROUND</span>((UnitPrice * Quantity * (<span class="dv">1</span> - Discount)), <span class="dv">2</span>)) [Final Price]
<span class="kw">INTO</span> #tempFinalPrices
<span class="kw">FROM</span> Orders O
    <span class="kw">INNER</span> <span class="kw">JOIN</span> [<span class="kw">Order</span> Details] OD <span class="kw">ON</span> O.OrderID = OD.OrderID
<span class="kw">GROUP</span> <span class="kw">BY</span> O.OrderID;

<span class="kw">SELECT</span> * <span class="kw">FROM</span> #tempFinalPrices;

<span class="kw">DROP</span> <span class="kw">TABLE</span> #tempFinalPrices;</code></pre></div>
<h2 id="sql-in-operator">SQL IN Operator</h2>
<p>The IN operator allows you to specify multiple values in a WHERE clause.</p>
<p>Syntax:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> column_name(s)
<span class="kw">FROM</span> table_name
<span class="kw">WHERE</span> column_name <span class="kw">IN</span> (value1,value2,...);</code></pre></div>
<h2 id="sql-in-operator-example">SQL IN Operator example</h2>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">-- How many objects has each customer from Canada, UK and USA ordered each year?</span>
<span class="kw">SELECT</span> C.CompanyName, C.Country, <span class="dt">YEAR</span>(O.OrderDate) <span class="kw">AS</span> [<span class="dt">Year</span>], <span class="fu">SUM</span>( OD.Quantity ) [Total Quantity]
<span class="kw">FROM</span> Customers C
    <span class="kw">INNER</span> <span class="kw">JOIN</span> Orders O <span class="kw">ON</span> C.CustomerID = O.CustomerID
    <span class="kw">INNER</span> <span class="kw">JOIN</span> [<span class="kw">Order</span> Details] OD <span class="kw">ON</span> O.OrderID = OD.OrderID
<span class="kw">WHERE</span> C.Country <span class="kw">IN</span> (<span class="st">&#39;UK&#39;</span>, <span class="st">&#39;USA&#39;</span>, <span class="st">&#39;Canada&#39;</span>)
<span class="kw">GROUP</span> <span class="kw">BY</span> C.CompanyName, <span class="dt">YEAR</span>(O.OrderDate), C.Country
<span class="kw">ORDER</span> <span class="kw">BY</span> C.CompanyName, <span class="dt">YEAR</span>(O.OrderDate);</code></pre></div>
<h2 id="subqueries">Subqueries</h2>
<p>Queries embedded in queries.</p>
<p>Example:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">-- Find the name of the company that placed order 10290.</span>
<span class="kw">SELECT</span> CompanyName
<span class="kw">FROM</span> Customers
<span class="kw">WHERE</span> CustomerID = (<span class="kw">SELECT</span> CustomerID
            <span class="kw">FROM</span> Orders
            <span class="kw">WHERE</span> OrderID = <span class="dv">10290</span>);</code></pre></div>
<p>Better example why to use a subquery:</p>
<p>Example:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">-- Find the Companies that placed orders in 1997</span>
<span class="kw">SELECT</span> CompanyName
<span class="kw">FROM</span> Customers
<span class="kw">WHERE</span> CustomerID <span class="kw">IN</span> (<span class="kw">SELECT</span> CustomerID
            <span class="kw">FROM</span> Orders
            <span class="kw">WHERE</span> OrderDate <span class="kw">BETWEEN</span> <span class="st">&#39;1997-01-01&#39;</span> <span class="kw">AND</span> <span class="st">&#39;1997-12-31&#39;</span>);</code></pre></div>
<h2 id="views">VIEWS</h2>
<p>A view is a virtual table. A view is nothing more than a SQL statement that is stored in the database<br />
with an associated name. A view is actually a composition of a table in the form of a predefined SQL query.</p>
<p>Syntax</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">CREATE</span> <span class="kw">VIEW</span> view_name <span class="kw">AS</span>
<span class="kw">SELECT</span> column1, column2.....
<span class="kw">FROM</span> table_name
<span class="kw">WHERE</span> [condition];</code></pre></div>
<h2 id="views-example">VIEWS Example</h2>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">CREATE</span> <span class="kw">VIEW</span> [<span class="kw">Current</span> Product <span class="kw">List</span>] <span class="kw">AS</span>
<span class="kw">SELECT</span> ProductID,ProductName
<span class="kw">FROM</span> Products
<span class="kw">WHERE</span> Discontinued=<span class="dv">0</span>;

<span class="kw">SELECT</span> * <span class="kw">FROM</span> [<span class="kw">Current</span> Product <span class="kw">List</span>];</code></pre></div>
<h2 id="tips-and-tricks-for-the-excersises">Tips and Tricks for the excersises</h2>
<ul>
<li>Use aliases for table names (e.g. SELECT C.CompanyName FROM Customers AS C)</li>
<li>Use DISTINCT for distinct results (for checking purposes)</li>
<li>BEGIN TRANSACTION ... ROLLBACK from INSERT, UPDATE, DELETE commands</li>
<li>Use @@ROWCOUNT to check number of affected rows</li>
<li>Always use WHERE clause for DELETE and UPDATE commands</li>
<li>Try to never use CURSORS and WHILE loops</li>
<li>Prefer table variables to temporary tables</li>
</ul>

<hr />
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons Licence" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
  </body>
</html>
