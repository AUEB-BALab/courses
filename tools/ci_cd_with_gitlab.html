<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>CD and CI on GitLab</title>

    <!-- Bootstrap -->
    <!-- JQuery is required -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="../css/pandoc-syntax.css">
  </head>
  <body>
<h1 id="--cd-and-ci-on-gitlab">Προγραμματισμός ΙΙ: CD and CI on GitLab</h1>
<p><img src="media/AUEB_logo.jpg" width="425" /> <img src="media/BA_Lab.png" width="425" /></p>
<h1 id="tools-and-practices-continuous-integration-and-deployment">Tools and practices: Continuous Integration and Deployment</h1>
<ul>
<li><a href="https://www.balab.aueb.gr/stefanos-georgiou.html">Στέφανος Γεωργίου</a></li>
</ul>
<h1 id="agenda">Agenda</h1>
<ul>
<li>What is CI/CD?<br /></li>
<li>AllCanCode Case<br /></li>
<li>Without CI/CD<br /></li>
<li>Build stages<br /></li>
<li>Caching data<br /></li>
<li>Optimizations<br /></li>
<li>First CI pipeline<br /></li>
<li>Point out drawbacks<br /></li>
<li>Second Attemp<br /></li>
<li>Outcome</li>
</ul>
<h1 id="what-is-cicd">What is CI/CD</h1>
<ul>
<li>CI = Continuous Integration<br /></li>
<li>CD = Continuous Deployment<br /></li>
<li>Reducing manual labor for deployment and lessens testing time of newly integrated code.</li>
</ul>
<h1 id="allcancode-platform">AllCanCode Platform</h1>
<p><img src="media/acc_platform.png" /></p>
<h1 id="acc-process">ACC Process</h1>
<p><img src="media/acc_software_stack.svg" height="546" /></p>
<h1 id="without-cicd">Without CI/CD</h1>
<ul>
<li>Running back-end tests (using mocha-chai)<br /></li>
<li>Manually perform front-end test on the platform<br /></li>
<li><p>Depoy to Google's App Engine the platform</p>
<ul>
<li>Alpha<br /></li>
<li>WWW<br /></li>
<li>Next<br /></li>
</ul></li>
<li><p>Running cordova to build native code, singing, and deploying</p>
<ul>
<li>APKs to Play Store<br /></li>
<li>IPAs to App Store<br /></li>
</ul></li>
<li><p>Approximate time: 40 minutes</p></li>
</ul>
<p><img src="media/doggy_work.jpg" height="586" /></p>
<h1 id="challenges">Challenges</h1>
<ul>
<li>Automate front-end testing<br /></li>
<li>Automate CI/CD<br /></li>
<li>Automate mobile apps build and deployment</li>
</ul>
<h1 id="automate-front-end-testing">Automate front-end testing</h1>
<pre><code>describe(&#39;Testing platform components&#39;, function () {
  beforeEach(() =&gt; {
    cy.visit(&#39;http://localhost:4200/projects/32bf5c50050411e8826c116cafab203f/versions/53/components/c843e1b0284011e8ba31cd640de39f04&#39;)
    cy.wait(5000); // Necessary to avoid slow starts of the webpage
    cy.get(&#39;input[placeholder=&quot;E-mail&quot;]&#39;).type(&#39;acc_test@allcancode.com{enter}&#39;);
    cy.get(&#39;input[placeholder=&quot;Password&quot;]&#39;).type(&#39;justatest{enter}&#39;);
    cy.contains(&#39;span&#39;, &#39;LOG IN&#39;).click();
  })

  it(&#39;should login and create a project&#39;, () =&gt; {
    cy.contains(&#39;span&#39;, &#39;Open Project&#39;);
    cy.contains(&#39;mat-card-title&#39;, &#39;allcancode&#39;);
    cy.contains(&#39;mat-card-subtitle&#39;, &#39;Allcancode Core Components&#39;);
  });
})</code></pre>
<h1 id="cypress-example">Cypress example</h1>
<video controls>
    <source src="media/acc_front_end_testing_with_cypress.mp4" type="video/mp4">
</video>



<h1 id="enabling-cicd-on-gitlab">Enabling CI/CD on GitLab</h1>
<ul>
<li><p>Just create a .gitlab-ci.yml in your project's root directory</p>
<ul>
<li>Declare Stages<br /></li>
<li>Cache data or modules<br /></li>
<li>Install dependencies on container or VM<br /></li>
</ul></li>
<li>On push the CI/CD pipeline will be executed<br /></li>
<li><p>Upon success or failure you are being notified by an email</p></li>
</ul>
<h1 id="simple-yaml">Simple YAML</h1>
<pre><code>image: node:latest
job:
  before_script:
    - apt update
    - apt install -y apt-transport-https ca-certificates curl gnupg2 software-properties-common
  script:
    - cd js_apps
    - npm i
    - npm test</code></pre>
<h1 id="build-stages">Build stages</h1>
<ul>
<li>To group jobs and run them sequencially or in parallel (e.g., testing different environments)<br /></li>
<li>Works as a pipeline among build stages<br /></li>
<li>Can cache and pass data and modules among build stages<br /></li>
<li>Suggested stages: build, test, deploy, and release<br />```<br />stages:<br /></li>
<li>build<br /></li>
<li>test<br /></li>
<li>deploy<br /></li>
<li>release<br />```</li>
</ul>
<h1 id="multiple-evnironments">Multiple Evnironments</h1>
<p><img src="media/multible_env.png" /></p>
<h1 id="caching-data-1">Caching data (1)</h1>
<ul>
<li>To store directories among builds, usually dependencies that take longer to compile or download (npm, pip, Maven)<br /></li>
<li>Uploads the cached data after the script phase but before after success or failure<br /></li>
<li><p>Large files that are quick to install but slow to download do not benefit from caching</p>
<pre><code>cache:
  untracked: true
  paths:
- node_modules/</code></pre></li>
</ul>
<h1 id="caching-data-2">Caching data (2)</h1>
<p><img src="media/uploading_cache.png" /><br /><img src="media/downloading_cache.png" /></p>
<h1 id="first-ci-pipeline">First CI pipeline</h1>
<pre><code>cache:
  untracked: true
  paths:
    - node_modules/
    - acc-front/dist/*
stages:
  - build
  - test
  - deploy

build:
  stage: build [...]

test_back_end:
  stage: test [...]

test_front_end:
  stage: test [...]

deploy:
  stage: deploy [...]</code></pre>
<h1 id="first-ci-build">First CI, build</h1>
<pre><code>build:
  stage: build
  image: node:latest
  before_script:
    - apt-get update
  script:
    - npm i
    - export ACC_VERSION=$(node -pe &quot;require(&#39;./package.json&#39;)[&#39;version&#39;]&quot;)
    - export DEPLOY_URL=$(echo &quot;https://files.allcancode.com/builds/app-files/platform/${ACC_VERSION}/&quot;)
    - echo ${ACC_VERSION}
    - cd acc-front
    - rm -rf node_modules/*
    - npm i
    - node_modules/@angular/cli/bin/ng build --prod --build-optimizer --preserve-symlinks --base-href / --deploy-url ${DEPLOY_URL}
    - cd ..</code></pre>
<h1 id="first-ci-test">First CI, test</h1>
<pre><code>test_back_nend:
  stage: test
  image: node:latest
  before_script:
    - apt-get update
    - apt-get install -y apt-transport-https ca-certificates curl gnupg2 software-properties-common       
    - curl -fsSL https://download.docker.com/linux/debian/gpg | apt-key add -
    - apt-key fingerprint 0EBFCD88
    - add-apt-repository &quot;deb [arch=amd64] https://download.docker.com/linux/debian $(lsb_release -cs) stable&quot;
    - apt-get update
    - apt-get install -y docker-ce
    - service docker status || service docker start
    - service docker status
  script:      
    - docker run --name redis_instance -p 6379:6379 -d redis redis-server
    - docker run --name mongo_instance --restart=always -d -p 27017:27017 mongo mongod
    - sh test.sh</code></pre>
<h1 id="first-ci-test-1">First CI, test</h1>
<pre><code>test_front_end:
  stage: test
  image: node:latest
  before_script:
    - apt-get update
    - apt-get install -y xvfb libgtk2.0-0 libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2
    - npm i --save-dev cypress
  script:
    - bash cli.sh remote &amp;
    - cd acc-front
    - bash devrun.sh &amp;
    - cd ../
    - bash checkRunning.sh
    - node_modules/cypress/bin/cypress run --spec cypress/integration/acc-front/login.spec.js
    - node_modules/cypress/bin/cypress run --spec cypress/integration/acc-front/projectPage.spec.js</code></pre>
<h1 id="first-ci-deploy">First CI, deploy</h1>
<pre><code>deploy:
  stage: deploy
  image: google/cloud-sdk:latest
  before_script:
    - export ACC_VERSION=$(cat ACC_VERSION)
    - export ACC_VERSION=$(echo ${ACC_VERSION} | awk &#39;{print $2}&#39;)
    - echo ${ACC_VERSION}
    - echo $SERVICE_ACCOUNT &gt; /tmp/$CI_PIPELINE_ID.json
    - gcloud auth activate-service-account --key-file /tmp/$CI_PIPELINE_ID.json
    - gcloud config set project allcancode-platform
  after_script:
    - rm /tmp/$CI_PIPELINE_ID.json
    - rm ACC_VERSION
  script:
    - export STORAGE_PATH=$( echo &quot;gs://allcancode-files/builds/app-files/platform/${ACC_VERSION}&quot;)
    - gsutil -m cp -r -z html,css,js acc-front/dist ${STORAGE_PATH}
    - gsutil -m setmeta -h &quot;Cache-Control:public, max-age=31536000&quot; ${STORAGE_PATH}/**/*
    - gsutil -m acl ch -r -u AllUsers:R ${STORAGE_PATH}/*
    - gcloud app deploy app-alpha.yaml --version=v${ACC_VERSION//\./\-} --quiet</code></pre>
<h1 id="deploying-to-gcloud">Deploying to Gcloud</h1>
<pre><code>runtime: custom
env: flex

automatic_scaling:
  min_num_instances: 3
  max_num_instances: 16
  cool_down_period_sec: 180
  cpu_utilization:
    target_utilization: 0.6

resources:
  cpu: 1
  memory_gb: 1
  disk_size_gb: 10

env_variables:
  ACC_NODE: &quot;node-P&quot;
  NODE_ENV: &quot;production&quot;

liveness_check:
  [...]

readiness_check:
  [...]</code></pre>
<h1 id="app-engine-container-file">App Engine Container File</h1>
<pre><code>FROM gcr.io/allcancode-platform/acc-server-image-3

# COPY Application
COPY . /app/

RUN npm install --unsafe-perm || \
    ((if [ -f npm-debug.log ]; then \
    cat npm-debug.log; \
    fi) &amp;&amp; false)

# Start the server
CMD npm start</code></pre>
<h1 id="first-ci-outcome">First CI outcome</h1>
<p><img src="media/first_ci_cd_outcome.png" /></p>
<p><img src="media/but_why.jpg" height=555 /></p>
<h1 id="pointing-out-drawbacks">Pointing out drawbacks</h1>
<ul>
<li>Is it necessary to cache all data between stages?<br /></li>
<li>Should every branch execute all stages?<br /></li>
<li>Do we need all these stages?<br /></li>
<li>Do we need to install mongo and redis?</li>
</ul>
<h1 id="optimizations-on-caching">Optimizations on caching</h1>
<pre><code>build_acc_front:
  stage: build
  image: node:11.15.0
  cache:
    untracked: true
    paths:
      - acc-front/dist/*
      - [...]</code></pre>
<h1 id="optimizations-on-stages">Optimizations on stages</h1>
<pre><code>deploy_to_gcloud:
  stage: deploy
  image: google/cloud-sdk:latest
  only:
    - master [...]

test_front:
  stage: test
  image: node:11.15.0
  except:
    - master [...]</code></pre>
<h1 id="merging-stages">Merging stages</h1>
<p><img src="media/test.png" /><br /><img src="media/deploy.png" /></p>
<p><img src="media/chuck_norris_approves.jpg" /></p>
<h1 id="cicd-mobile-apps">CI/CD mobile apps</h1>
<p>Before we used Adobe's Phonegap to export cordova projects.</p>
<ul>
<li>Unreliable software on updates<br /></li>
<li>Failing without giving reason<br /></li>
<li>Cordova project size limit 100MB</li>
</ul>
<h1 id="bitrise-cicd-for-mobile">Bitrise CI/CD for mobile</h1>
<ul>
<li>Customize branches workflows<br /></li>
<li>Sign code<br /></li>
<li>Publish to Play and App store<br /></li>
<li>CLI for local testing<br /></li>
<li>Integrate with chatting platforms</li>
</ul>
<h1 id="bitrise-yaml">Bitrise YAML</h1>
<pre><code>format_version: &#39;7&#39;
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: cordova
trigger_map:
- push_branch: &quot;*&quot;
  workflow: primary
- pull_request_source_branch: &quot;*&quot;
  workflow: primary
workflows:
  primary:
    steps:
    - activate-ssh-key@4.0.3:
        run_if: &#39;{{getenv &quot;SSH_RSA_PRIVATE_KEY&quot; | ne &quot;&quot;}}&#39;
    - git-clone@4.0.14: {}
    - npm@1.0.2:
        inputs:
        - command: install
        - workdir: &quot;$CORDOVA_WORK_DIR&quot;
    - cordova-archive@2.0.0:
        inputs:
        - workdir: &quot;$CORDOVA_WORK_DIR&quot;
        - platform: &quot;$CORDOVA_PLATFORM&quot;
        - target: device
    - sign-apk@1.3.1:
        inputs:
        - keystore_alias: app
        - keystore_url: file://app.jks
        - keystore_password: ***
    - deploy-to-bitrise-io@1.6.0: {}
app:
  envs:
    [...]</code></pre>
<h1 id="bitrise-gui">Bitrise GUI</h1>
<p><img src="media/bitrise_gui.png" /></p>
<h1 id="final-cicd-pipeline">Final CI/CD pipeline</h1>
<p><img src="media/acc_ci_cd.svg" /></p>

<hr />
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons Licence" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
  </body>
</html>
